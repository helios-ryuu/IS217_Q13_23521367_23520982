-- Câu 1: Liệt kê Top 10 bang có nhiều vụ tai nạn nhất. --ok

SELECT 
    [Measures].[Total Accidents] ON COLUMNS,
    TOPCOUNT (
        [DIM LOCATION].[STATE].[STATE].MEMBERS, 10, [Measures].[Total Accidents]
    ) ON ROWS
FROM [US Accidents DW]

-- Câu 2: Hiển thị các thành phố có số vụ tai nạn lớn hơn 1000 trong quý 1 năm 2023. --ok

SELECT 
    [Measures].[Total Accidents] ON COLUMNS,
    FILTER([DIM LOCATION].[CITY].children,
    [Measures].[Total Accidents] > 1000
    ) ON ROWS
FROM [US Accidents DW]
WHERE ([DIM TIME].[Hierarchy].[QUARTER].&[1]&[2023]);


-- Câu 3: Ảnh hưởng của điều kiện thời tiết đến độ nguy hiểm tai nạn trong năm 2020 ở khu vực gần các tiện ích (trường học, bệnh viện) ở các bang. --ok

WITH 
MEMBER [Measures].[AvgSeverity] AS
    ROUND([Measures].[SEVERITY] / [Measures].[Total Accidents],2)
MEMBER [Measures].[DangerIndex] AS
    ([Measures].[Total Accidents] * [Measures].[AvgSeverity])
SELECT 
    [Measures].[DangerIndex] ON COLUMNS,
    NON EMPTY CROSSJOIN (
    [DIM LOCATION].[STATE].[STATE].Members,
    [DIM WEATHER].[WEATHER CONDITION].[WEATHER CONDITION].Members
    ) ON ROWS
FROM [US Accidents DW]
WHERE ([DIM TIME].[YEAR].&[2020], [DIM ENVIRONMENT].[AMENITY].&[True]);

-- Câu 4: Hiển thị tần suất xảy ra tai nạn và độ nghiêm trọng theo quý qua từng năm. --ok

SELECT 
    {[Measures].[Total Accidents], [Measures].[AvgSeverity]} ON COLUMNS,
    NON EMPTY
    [Dim Time].[Year].[Year].Members * 
    [Dim Time].[Quarter].[Quarter].Members ON ROWS
FROM [US Accidents DW];

-- Câu 5: Phân tích mức độ nguy hiểm theo trạng thái Ngày/Đêm, phân loại 
-- theo từng bang. --ok

SELECT
    {[Measures].[DangerIndex]} ON COLUMNS,
    NON EMPTY CROSSJOIN (
        [DIM LOCATION].[STATE].[STATE].MEMBERS,
        EXCEPT([DIM WEATHER].[SUNRISE SUNSET].[SUNRISE SUNSET].MEMBERS, 
        [DIM WEATHER].[SUNRISE SUNSET].[Unknown])
    )ON ROWS
FROM [US Accidents DW];











-- Câu 6: Hiển thi 10 con đường nguy hiểm nhất trong năm 2022. --ok

SELECT 
    {[Measures].[DangerIndex], [Measures].[Total Accidents], [Measures].[AvgSeverity]} ON COLUMNS,
    HEAD(
    ORDER([DIM LOCATION].[STREET].[STREET].MEMBERS, [Measures].[DangerIndex], DESC),
        10
    ) ON ROWS
FROM [US Accidents DW]
WHERE ([DIM TIME].[YEAR].&[2022]);


-- Câu 7: Với từng bang, liệt kê top 3 thành phố có nhiều vụ tai nạn nhất trong năm 2022. --ok

SELECT
  {[Measures].[Total Accidents]} ON COLUMNS,
  {
    GENERATE(
        [DIM LOCATION].[STATE].[STATE].members,
        TOPCOUNT(
           {[DIM LOCATION].[STATE].currentmember *
            [DIM LOCATION].[CITY].children},
            3,
            [Measures].[Total Accidents])
    )
  } ON ROWS
FROM [US Accidents DW]
WHERE ([DIM TIME].[YEAR].&[2022]);




-- Câu 8: Xếp hạng 5 thành phố có tỷ lệ tai nạn nghiêm trọng nhất trong tiểu bang california. --ok

SELECT 
    {[Measures].[DangerIndex]} ON COLUMNS,
    TOPCOUNT(
        [DIM LOCATION].[CITY].[CITY].MEMBERS,
        5,
        [Measures].[DangerIndex]
    ) ON ROWS
FROM [US Accidents DW]
WHERE ([DIM LOCATION].[STATE].&[CA])



-- Câu 9: Phân tích tốc độ tăng trưởng số vụ tai nạn qua từng năm theo tiểu bang. --ok

WITH 
MEMBER [Measures].[YoYGrowth_Percent] AS 
    IIF(
        ([DIM TIME].[YEAR].PrevMember, [Measures].[Total Accidents]) = 0,
        NULL,
        ROUND((
            ([DIM TIME].[YEAR].CurrentMember, [Measures].[Total Accidents])
            - ([DIM TIME].[YEAR].PrevMember, [Measures].[Total Accidents])
        )
        / ([DIM TIME].[YEAR].PrevMember, [Measures].[Total Accidents]),2)
    ),
    FORMAT_STRING = "Percent"

SELECT 
    {
        [Measures].[Total Accidents],
        [Measures].[YoYGrowth_Percent]
    } ON COLUMNS,
    NON EMPTY
      CrossJoin(
           [DIM LOCATION].[STATE].[STATE].MEMBERS,
            [DIM TIME].[YEAR].[YEAR].MEMBERS
      )
    ON ROWS
FROM [US Accidents DW]

-- Câu 10: Hiển thị Top 5 thành phố có tăng trưởng trung bình số vụ tai nạn cao nhất giai đoạn 2018–2023. --ok

WITH 
MEMBER [Measures].[Avg YoY Growth Range] AS
    ROUND(AVG(
    EXISTING [DIM TIME].[YEAR].[YEAR].MEMBERS,
    [Measures].[YoYGrowth_Percent]   
    ),2)
SELECT 
    TOPCOUNT(
        [DIM LOCATION].[CITY].[CITY].Members,
        20,
        [Measures].[Avg YoY Growth Range]
    ) ON ROWS,
    {[Measures].[Avg YoY Growth Range]} ON COLUMNS
FROM [US Accidents DW];

-- Câu 11: Tại mỗi bang, so sánh số lượng tai nạn xảy ra ở khu vực có Đèn giao thông (Traffic Signal) so với khu vực có Biển báo dừng (Stop Sign).
WITH 
MEMBER [Measures].[Accidents (Traffic Signal)] AS
    ([Measures].[Total Accidents],[DIM ENVIRONMENT].[TRAFFIC SIGNAL].&[True])

MEMBER [Measures].[Accidents (Stop Sign)] AS
    ([Measures].[Total Accidents], [DIM ENVIRONMENT].[STOP].&[True])

SELECT
    {[Measures].[Accidents (Traffic Signal)],
    [Measures].[Accidents (Stop Sign)]} ON COLUMNS,
    NON EMPTY [DIM LOCATION].[STATE].[STATE].MEMBERS ON ROWS
FROM [US Accidents DW];

